---
name: Build - Linux AppImage
permissions:
  contents: read

on:
  workflow_call:
    inputs:
      ci_version:
        required: true
        type: string
  workflow_dispatch:
    inputs:
      ci_version:
        description: 'Version string (leave empty to use commit SHA)'
        required: false
        type: string

jobs:
  build:
    env:
      CI_VERSION: ${{ inputs.ci_version || github.sha }}
    strategy:
      matrix:
        arch: [x86_64, arm64]
        include:
          - arch: x86_64
            runner: ubuntu-22.04
            linuxdeployqt_arch: x86_64
          - arch: arm64
            runner: ubuntu-22.04-arm
            linuxdeployqt_arch: aarch64
    runs-on: ${{ matrix.runner }}
    container:
      image: ubuntu:20.04
      options: --privileged

    steps:
      - name: Install Git
        run: |
          apt-get update
          apt-get install -y git

      - name: Checkout Repository
        uses: actions/checkout@v5
        with:
          submodules: 'recursive'
          fetch-depth: 1

      - name: Setup environment
        run: |
          apt-get update
          # Add LunarG Vulkan repository (only for x86_64)
          if [ "${{ matrix.arch }}" = "x86_64" ]; then
            mkdir -p /etc/apt/keyrings
            wget -qO - https://packages.lunarg.com/lunarg-signing-key-pub.asc | tee /etc/apt/keyrings/lunarg.asc > /dev/null
            echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/lunarg.asc] https://packages.lunarg.com/vulkan/1.4.313 focal main" | tee /etc/apt/sources.list.d/lunarg-vulkan-1.4.313-focal.list > /dev/null
            apt-get update
          fi
          # Install base packages
          apt-get install -y qt6-base-dev qt6-declarative-dev libqt6svg6-dev qml6-module-qtquick-controls qml6-module-qtquick-templates qml6-module-qtquick-layouts \
            qml6-module-qtqml-workerscript qml6-module-qtquick-window qml6-module-qtquick python3-pip nasm libgbm-dev libdrm-dev libfreetype-dev libasound2-dev \
            libdbus-1-dev libegl1-mesa-dev libgl1-mesa-dev libgles2-mesa-dev libglu1-mesa-dev libibus-1.0-dev libpulse-dev libudev-dev libx11-dev libxcursor-dev \
            libxext-dev libxi-dev libxinerama-dev libxkbcommon-dev libxrandr-dev libxss-dev libxt-dev libxv-dev libxxf86vm-dev libxcb-dri3-dev libx11-xcb-dev \
            wayland-protocols libopus-dev libvdpau-dev libgl-dev libpipewire-0.3-dev wget build-essential autoconf automake libtool pkg-config meson ninja-build
          # Install Vulkan SDK based on architecture
          if [ "${{ matrix.arch }}" = "x86_64" ]; then
            apt-get install -y vulkan-sdk || (echo "Warning: vulkan-sdk not available, trying libvulkan-dev" && apt-get install -y libvulkan-dev vulkan-tools)
          else
            apt-get install -y libvulkan-dev vulkan-tools vulkan-loader-dev || apt-get install -y libvulkan-dev
            apt-get install -y vulkan-validationlayers-dev 2>/dev/null || echo "Note: vulkan-validationlayers-dev not available, skipping"
          fi
          pip3 install meson
          mkdir -p dep_root/{bin,include,lib}
          echo "DEP_ROOT=$PWD/dep_root" >> "${GITHUB_ENV}"
          echo "$PWD/dep_root/bin" >> "${GITHUB_PATH}"

      - name: Checkout SDL
        uses: actions/checkout@v5
        with:
          repository: libsdl-org/SDL
          ref: 3eba0b6f8a21392f47b1b53a476e7633048de9b1
          path: deps/SDL

      - name: Build SDL
        working-directory: deps/SDL
        run: |
          ./autogen.sh
          ./configure
          make -j$(nproc)
          make install

      - name: Checkout SDL_ttf
        uses: actions/checkout@v5
        with:
          repository: libsdl-org/SDL_ttf
          ref: release-2.22.0
          path: deps/SDL_ttf
          submodules: 'recursive'

      - name: Build SDL_ttf
        working-directory: deps/SDL_ttf
        run: |
          ./autogen.sh
          ./configure
          make -j$(nproc)
          make install

      - name: Checkout libva
        uses: actions/checkout@v5
        with:
          repository: intel/libva
          ref: 2.23.0
          path: deps/libva

      - name: Build libva
        working-directory: deps/libva
        run: |
          ./autogen.sh
          ./configure --enable-x11
          make -j$(nproc)
          make install

      - name: Checkout libplacebo
        uses: actions/checkout@v5
        with:
          repository: haasn/libplacebo
          ref: bc90ef94944a3dcaab324b86d3e3769ad1d8698b
          path: deps/libplacebo
          submodules: 'recursive'

      - name: Build libplacebo
        working-directory: deps/libplacebo
        run: |
          git apply ../../app/deploy/linux/appimage/*.patch
          meson setup build -Dvulkan=enabled -Dopengl=disabled -Ddemos=false
          ninja -C build
          ninja install -C build

      - name: Build dav1d
        working-directory: deps
        env:
          DAV1D_VER: 1.5.2
        run: |
          git clone --branch $DAV1D_VER --depth 1 https://code.videolan.org/videolan/dav1d.git
          pushd dav1d
          meson setup build -Ddefault_library=static -Dbuildtype=release -Denable_tools=false -Denable_tests=false
          ninja -C build
          ninja install -C build
          popd

      - name: Checkout FFmpeg
        uses: actions/checkout@v5
        with:
          repository: FFmpeg/FFmpeg
          ref: n8.0.1
          path: deps/FFmpeg

      - name: Build FFmpeg
        working-directory: deps/FFmpeg
        run: |
          # Configure FFmpeg with architecture-specific options
          if [ "${{ matrix.arch }}" = "x86_64" ]; then
            # x86_64: Enable all hardware acceleration including Vulkan
            ./configure --enable-pic --disable-static --enable-shared --disable-all --disable-autodetect --enable-avcodec --enable-avformat --enable-swscale \
              --enable-decoder=h264 --enable-decoder=hevc --enable-decoder=av1 \
              --enable-vaapi --enable-hwaccel=h264_vaapi --enable-hwaccel=hevc_vaapi --enable-hwaccel=av1_vaapi \
              --enable-vdpau --enable-hwaccel=h264_vdpau  --enable-hwaccel=hevc_vdpau --enable-hwaccel=av1_vdpau \
              --enable-libdrm --enable-vulkan --enable-hwaccel=h264_vulkan --enable-hwaccel=hevc_vulkan --enable-hwaccel=av1_vulkan \
              --enable-libdav1d --enable-decoder=libdav1d
          else
            # arm64: Disable Vulkan as it's not available in LunarG SDK, but keep other hardware acceleration
            echo "Configuring FFmpeg for arm64 without Vulkan support"
            ./configure --enable-pic --disable-static --enable-shared --disable-all --disable-autodetect --enable-avcodec --enable-avformat --enable-swscale \
              --enable-decoder=h264 --enable-decoder=hevc --enable-decoder=av1 \
              --enable-vaapi --enable-hwaccel=h264_vaapi --enable-hwaccel=hevc_vaapi --enable-hwaccel=av1_vaapi \
              --enable-vdpau --enable-hwaccel=h264_vdpau  --enable-hwaccel=hevc_vdpau --enable-hwaccel=av1_vdpau \
              --enable-libdrm \
              --enable-libdav1d --enable-decoder=libdav1d
          fi
          make -j$(nproc)
          make install

      - name: Install linuxdeployqt
        working-directory: dep_root/bin
        run: |
          wget -O linuxdeployqt https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-${{ matrix.linuxdeployqt_arch }}.AppImage
          chmod a+x linuxdeployqt

      - name: Build Binaries
        run: |
          ldconfig
          scripts/build-appimage.sh

      - name: Upload Binaries
        uses: actions/upload-artifact@v5
        with:
          name: Moonlight-LinuxAppImage-${{ env.CI_VERSION }}-${{ matrix.arch }}
          path: build/installer-release/Moonlight-${{ env.CI_VERSION }}-${{ matrix.arch }}.AppImage
          compression-level: 0
          if-no-files-found: error
