name: Build - Linux AppImage
permissions:
  contents: read

on:
  workflow_call:
    inputs:
      ci_version:
        required: true
        type: string
  workflow_dispatch:
    inputs:
      ci_version:
        description: 'Version string (leave empty to use commit SHA)'
        required: false
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64, arm64]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 1

      - name: Set up QEMU
        if: matrix.arch == 'arm64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Setup Build Script Permissions
        run: chmod +x scripts/ci-build-docker.sh scripts/build-appimage.sh

      - name: Build in Docker (Ubuntu 20.04)
        run: |
          # Use platform flag to ensure we run on the correct architecture (via QEMU if needed)
          PLATFORM="${{ matrix.arch == 'x86_64' && 'linux/amd64' || 'linux/arm64' }}"
          echo "Running build for ${{ matrix.arch }} on $PLATFORM"
          
          docker run --rm --privileged \
            --platform $PLATFORM \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -e CI_VERSION=${{ inputs.ci_version || github.sha }} \
            ubuntu:20.04 \
            /bin/bash /workspace/scripts/ci-build-docker.sh ${{ matrix.arch }}

      - name: Upload Binaries
        uses: actions/upload-artifact@v4
        with:
          name: Moonlight-LinuxAppImage-${{ inputs.ci_version || github.sha }}-${{ matrix.arch }}
          path: build/installer-release/*.AppImage
          compression-level: 0
          if-no-files-found: error
